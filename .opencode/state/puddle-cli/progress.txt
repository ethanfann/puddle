# Progress Log
PRD: puddle-cli
Started: 2026-01-21

## Codebase Patterns
- Shell script structure: shebang, set -euo pipefail, VERSION, usage(), global opts, command dispatch
- Error output: JSON to stderr with error/message keys (will switch to plain text in polish-1)
- Exit codes: 0=success, 1=general error, 2=API error, 3=not found
- Token loading: Check --token flag first, then RAINDROP_TOKEN env, then ~/.config/puddle/token file
- API helper: `api_request METHOD /endpoint [data]` handles auth, errors, exit codes
- URL encoding: `printf '%s' "$str" | jq -sRr @uri`
- Response extraction: `echo "$response" | jq '.items'`

---

## Task - setup-1
- Created scripts/puddle executable
- Usage help on no args or --help
- Version output on --version
- Command dispatch stub returns not_implemented JSON error
- **Files:** scripts/puddle

## Task - core-1
- Implemented token loading from env var, config file, and --token flag
- --token flag overrides env var and config file
- Missing token shows JSON error and exits with code 1
- Token stored in TOKEN variable for use by commands
- **Files:** scripts/puddle
- **Learnings:** Use `cat file | tr -d '\n'` to load token without trailing newline

## Task - core-2
- Implemented `puddle ls [search]` with API integration
- Added `api_request` helper function for all API calls
- Supports --collection, --page, --perpage flags
- URL encodes search query with jq
- Extracts `.items` array from response
- **Files:** scripts/puddle
- **Learnings:** Use `jq -sRr @uri` for URL encoding in bash

## Task - core-3
- Implemented `puddle get <id>` to fetch single bookmark
- Validates ID is numeric, returns exit code 3 for invalid
- Extracts `.item` from API response
- **Files:** scripts/puddle

## Task - write-1
- Implemented `puddle add <url>` to create bookmarks
- Supports --title, --tags, --collection, --excerpt flags
- Tags converted from comma-separated string to JSON array
- Collection uses `{$id: N}` format for API
- Validates URL starts with http:// or https://
- **Files:** scripts/puddle
- **Learnings:** Use jq to build JSON payload incrementally with `--arg` and `--argjson`
