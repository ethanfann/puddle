# Progress Log
PRD: puddle-cli
Started: 2026-01-21

## Codebase Patterns
- Shell script structure: shebang, set -euo pipefail, VERSION, usage(), global opts, command dispatch
- Error output: plain text to stderr by default; JSON with --json flag
- Error helper: `error <exit-code> <error-type> <message>`
- Exit codes: 0=success, 1=general error, 2=API error, 3=not found
- Token loading: Check --token flag first, then RAINDROP_TOKEN env, then ~/.config/puddle/token file
- API helper: `api_request METHOD /endpoint [data]` handles auth, errors, exit codes
- URL encoding: `printf '%s' "$str" | jq -sRr @uri`
- Response extraction: `echo "$response" | jq '.items'`
- Flag validation: `require_flag_value "${1:-}" "$#" "--flag" || return 1`
- Tags parsing: `parse_tags "a,b,c"` -> `["a","b","c"]`
- JSON building: `json_add_string "$json" "field" "$value"`, `json_add_json "$json" "field" "$json_value"`

---

## Task - setup-1
- Created scripts/puddle executable
- Usage help on no args or --help
- Version output on --version
- Command dispatch stub returns not_implemented JSON error
- **Files:** scripts/puddle

## Task - core-1
- Implemented token loading from env var, config file, and --token flag
- --token flag overrides env var and config file
- Missing token shows JSON error and exits with code 1
- Token stored in TOKEN variable for use by commands
- **Files:** scripts/puddle
- **Learnings:** Use `cat file | tr -d '\n'` to load token without trailing newline

## Task - core-2
- Implemented `puddle ls [search]` with API integration
- Added `api_request` helper function for all API calls
- Supports --collection, --page, --perpage flags
- URL encodes search query with jq
- Extracts `.items` array from response
- **Files:** scripts/puddle
- **Learnings:** Use `jq -sRr @uri` for URL encoding in bash

## Task - core-3
- Implemented `puddle get <id>` to fetch single bookmark
- Validates ID is numeric, returns exit code 3 for invalid
- Extracts `.item` from API response
- **Files:** scripts/puddle

## Task - write-1
- Implemented `puddle add <url>` to create bookmarks
- Supports --title, --tags, --collection, --excerpt flags
- Tags converted from comma-separated string to JSON array
- Collection uses `{$id: N}` format for API
- Validates URL starts with http:// or https://
- **Files:** scripts/puddle
- **Learnings:** Use jq to build JSON payload incrementally with `--arg` and `--argjson`

## Task - write-2
- Implemented `puddle update <id>` to edit bookmark fields
- Supports --title, --note, --tags, --excerpt, --collection, --important flags
- --important validates true/false values
- Uses PUT /raindrop/{id} endpoint
- **Files:** scripts/puddle

## Task - write-3
- Implemented `puddle rm <id>` to delete bookmarks
- Uses DELETE /raindrop/{id} endpoint
- Validates ID is numeric, returns exit code 3 for invalid
- Returns deleted bookmark info on success
- **Files:** scripts/puddle

## Task - bulk-1
- Implemented `puddle tag add|rm <tag> --search '...'` for bulk tagging
- Uses PUT /raindrops/{collectionId}?search=... endpoint
- Supports --collection to limit operation scope
- Tag add uses `{tags: [tag]}`, rm uses `{$unset: {tags: [tag]}}`
- Returns `{modified: N, result: bool}`
- --search is required
- **Files:** scripts/puddle

## Task - bulk-2
- Implemented `puddle move <collection-id> --search '...'` for bulk moves
- Uses PUT /raindrops/{sourceCollectionId}?search=... endpoint
- Payload: `{collection: {$id: N}}`
- Supports --collection to specify source collection
- Validates collection ID is numeric (allows negative for system collections)
- Returns `{modified: N, result: bool}`
- **Files:** scripts/puddle

## Task - read-1
- Implemented `puddle collections` to list all collections
- Fetches both root (/collections) and nested (/collections/childrens) collections
- Merges results and filters out system collections (_id <= 0)
- Returns combined array with _id, title, count, parent fields
- **Files:** scripts/puddle
- **Learnings:** Use `cmd=$(subshell) || ret=$?` pattern to capture both output and return code

## Task - core-4
- Verified consistent error handling across all commands
- All errors output JSON to stderr with error/message keys
- API errors include status field with HTTP code
- Exit codes: 0=success, 1=general, 2=API 4xx, 3=not found/invalid ID
- No changes needed - patterns were already consistent
- **Files:** (audit only)

## Task - polish-1
- Added `error()` helper function for consistent error output
- Added global `--json` flag to force JSON errors for scripting
- Errors now plain text by default: "Error: <message>"
- JSON errors when `--json` flag: `{"error": "<type>", "message": "<msg>"}`
- Replaced all 35+ hardcoded JSON error calls with `error()` helper
- **Files:** scripts/puddle
- **Learnings:** Global flags must be parsed before command dispatch


## Task - polish-2
- Added `require_flag_value()` helper for consistent flag value validation
- Added `parse_tags()` helper to convert comma-separated string to JSON array
- Added `json_add_string()` and `json_add_json()` helpers for payload building
- Refactored cmd_ls, cmd_add, cmd_update, cmd_tag, cmd_move to use helpers
- Reduced script size by ~48 lines (707 -> 659)
- **Files:** scripts/puddle
- **Learnings:** Use `${1:-}` in helper params to handle unset vars with set -u

## Task - docs-1
- Created SKILL.md with YAML frontmatter (name, description, globs, compatibility, license)
- Added command reference table with all 8 commands
- Added quick examples section with common operations
- Added search syntax quick reference table
- Added command options documentation
- Added jq output processing examples
- Added exit codes table
- Points to references/SEARCH-DSL.md for complex queries
- **Files:** SKILL.md

## Task - docs-2
- Created references/SEARCH-DSL.md with comprehensive search syntax docs
- Documented all operators: tags (#), types, dates (created:), fields (title:, domain:, link:, etc.)
- Added special filters: notag, broken, duplicate, important, cache
- Added dynamic date examples with GNU and BSD date syntax
- Added complex query examples combining multiple operators
- Added extensive jq processing examples (filter, sort, group, export)
- Added pagination example for large result sets
- **Files:** references/SEARCH-DSL.md

## Task - docs-3
- Created README.md with project overview and setup instructions
- Documented requirements (bash 4+, curl, jq) with install commands
- Documented API token acquisition from Raindrop.io integrations page
- Documented all 3 token config methods: --token flag, RAINDROP_TOKEN env, config file
- Added quick start examples for all major commands
- Added command reference table
- Added search examples and output processing with jq
- Added exit codes table and global options
- Links to SKILL.md and SEARCH-DSL.md for detailed docs
- **Files:** README.md

