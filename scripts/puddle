#!/usr/bin/env bash
set -euo pipefail

VERSION="0.1.0"
TOKEN=""
API_BASE="https://api.raindrop.io/rest/v1"  # Will be used in command implementations

usage() {
  cat <<EOF
puddle - CLI for Raindrop.io bookmarks

Usage: puddle <command> [options]

Commands:
  ls [search]              List/search bookmarks
  get <id>                 Get a single bookmark
  add <url>                Add a new bookmark
  update <id>              Update a bookmark
  rm <id>                  Delete a bookmark
  tag add|rm <tag>         Bulk tag operations
  move <collection-id>     Bulk move bookmarks
  collections              List all collections

Global Options:
  --token <token>          API token (overrides env/config)
  --version                Show version
  --help                   Show this help

Environment:
  RAINDROP_TOKEN           API token (or ~/.config/puddle/token)

Examples:
  puddle ls '#react'
  puddle add 'https://example.com' --title 'Example' --tags 'a,b'
  puddle get 12345
  puddle rm 12345
EOF
}

# Parse global options first
while [[ $# -gt 0 ]]; do
  case "$1" in
    --version)
      echo "$VERSION"
      exit 0
      ;;
    --help|-h)
      usage
      exit 0
      ;;
    --token)
      shift
      if [[ $# -eq 0 ]]; then
        echo '{"error": "missing_value", "message": "--token requires a value"}' >&2
        exit 1
      fi
      TOKEN="$1"
      shift
      ;;
    *)
      break
      ;;
  esac
done

# If no command provided, show usage
if [[ $# -eq 0 ]]; then
  usage
  exit 0
fi

# Load token if not already set by --token flag
if [[ -z "$TOKEN" ]]; then
  # Check environment variable
  if [[ -n "${RAINDROP_TOKEN:-}" ]]; then
    TOKEN="$RAINDROP_TOKEN"
  # Check config file
  elif [[ -f "$HOME/.config/puddle/token" ]]; then
    TOKEN=$(cat "$HOME/.config/puddle/token" | tr -d '\n')
  fi
fi

# Verify token exists
if [[ -z "$TOKEN" ]]; then
  echo '{"error": "missing_token", "message": "No token found. Set RAINDROP_TOKEN env var, create ~/.config/puddle/token file, or use --token flag"}' >&2
  exit 1
fi

# Command dispatch (to be implemented)
cmd="${1:-}"
shift || true

case "$cmd" in
  ls|get|add|update|rm|tag|move|collections)
    echo "{\"error\": \"not_implemented\", \"message\": \"Command '$cmd' not yet implemented\"}" >&2
    exit 1
    ;;
  *)
    echo "{\"error\": \"unknown_command\", \"message\": \"Unknown command: $cmd\"}" >&2
    exit 1
    ;;
esac
